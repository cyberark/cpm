---
# tasks file for cpm_hardening

- name: Create user.ini file
  win_file:
    path: "{{ cpm_installation_path }}\\Password Manager\\Vault\\user.ini"
    state: touch

- name: Hardening Block
  block:

    - name: run CPM hardening
      win_shell: |
        $ErrorActionPreference = "SilentlyContinue"
        $Action = .\CPM_Hardening.ps1
        $Action | Out-File -FilePath "{{ cpm_hardening_log }}"
        $Result = Get-Content "{{ cpm_hardening_log }}" | ConvertFrom-Json
        if ($Result.isSucceeded -ne 0) {
            exit 1
        } else {
            exit 0
        }
      args:
        chdir: "{{ cpm_installationautomation_folder }}"

  rescue:
  
    - name: Get log path for hardening
      win_shell: |
        $Result = Get-Content "{{ cpm_hardening_log }}"
        Write-Output $Result
      register: log_result

    - fetch:
        src: '{{ log_result.stdout | from_json | json_query("logPath") }}'
        dest: '{{ playbook_dir }}/logs/cpm/{{ inventory_hostname }}_hardening.log'
        flat: yes

    - fail:
        msg: 'ERROR: Hardening failed. For more info check {{ playbook_dir }}/logs/cpm/{{ inventory_hostname }}_hardening.log'

- name: validate hardening
  win_service: 
    name: "{{ cpm_service_name }}"
  register: cpm_service_info
  
- name: check if cpm scanner service is running
  win_service: 
    name: "{{ cpm_scanner_service_name }}"
  register: cpm_scanner_service_info
  
- set_fact:
    cpm_hardened: true
  when: cpm_service_info.username != "LocalSystem" and cpm_scanner_service_info.username != "LocalSystem"