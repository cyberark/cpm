---
# tasks file for cpm registration

- debug: msg={{ vault_password }}

- name: Execute CPM Registration
  win_command: "RegisterComponent.exe CPM /accepteula Yes /vaultip {{ vault_ip }} /vaultport {{ vault_port }} /vaultuser {{ vault_username }} /vaultpassword {{ vault_pass }}"
  args:
    chdir: "{{ cpm_registrationtool_folder }}"

# - name: run CPM registration #TODO check if there is a typo in 10.6
#   #TODO replace hard coded paths with variables
#   win_shell: |
#     Set-Location "{{ cpm_registrationtool_folder }}"
#     $ErrorActionPreference = "SilentlyContinue"
#     $Action = .\RegisterComponent.exe
#     $Action | Out-File -FilePath "C:\CyberArk\Ansible\cpm_registration_result.txt"
#     $Result = Get-Content "C:\CyberArk\Ansible\cpm_registration_result.txt" | ConvertFrom-Json
#     if ($Result.isSucceeded -eq 2) {
#       exit 1
#     } else {
#       exit 0
#     }
#   args:
#     chdir: "C:\\CyberArk\\Ansible\\CPM\\Central Policy Manager\\InstallationAutomation\\Registration" #TODO

# TODO: Validate CPM registration

- name: check if cpm service is running
  win_service: 
    name: "{{ cpm_service_name }}"
  register: cpm_service_info

- name: Set cpm_registered as true
  set_fact:
    cpm_registered: true
